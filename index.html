<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Űrhajó</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
:root{
  --bg:#071024;
  --panel-bg:rgba(255,255,255,0.04);
  --accent:#6fe8ff;
  --soft:#0b3b5a;
  --glass-border:rgba(255,255,255,0.06);
  --muted:#9fd3ff;
  --gold:#ffd166;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#020617 0%, #071024 60%);color:#dfeffb;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
.container{display:grid;grid-template-columns:280px 1fr;gap:20px;height:100vh;padding:20px 30px;align-items:start;}

.sidebar{
  position:relative;
  height:calc(100vh -40px);
  border-radius:18px;
  padding:18px;
  background:linear-gradient(180deg, rgba(10,20,35,0.85), rgba(6,10,18,0.7));
  box-shadow: 0 8px 30px rgba(2,6,14,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
  border:1px solid var(--glass-border);
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:16px;
}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px;}
.stat-card{
  background:var(--panel-bg);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
  box-shadow: 0 4px 14px rgba(2,8,20,0.45);min-height:58px;
  display:flex;flex-direction:column;justify-content:center;
}
.stat-card small{color:var(--muted);font-size:12px}
.stat-card .val{font-size:18px;font-weight:700}

.controls{display:flex;flex-direction:column;gap:10px;margin-top:6px}
.controls .btn{
  display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));cursor:pointer;
  transition:transform .12s ease, box-shadow .12s ease;
}
.controls .btn:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(14,48,80,0.45)}
.controls .btn.secondary{background:transparent;border:1px dashed rgba(255,255,255,0.03)}

.upgradePanel{
  margin-top:6px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
  border:1px solid rgba(255,255,255,0.03);
}
.upgrade-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.upgrade-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-radius:8px}
.upgrade-item .meta{display:flex;flex-direction:column}
.upgrade-item button{background:linear-gradient(180deg,#0b3b5a,#08405a);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer;transition:.12s}
.upgrade-item button:hover{transform:scale(1.03);box-shadow:0 6px 18px rgba(10,60,90,0.4)}

.sidebar-footer{margin-top:auto;font-size:12px;color:rgba(223,239,251,0.6);display:flex;flex-direction:column;gap:6px}
.toggle-upgrades{color:var(--gold);font-weight:700;cursor:pointer;text-decoration:underline}

.stage{
  display:flex;flex-direction:column;gap:10px;align-items:center;
  justify-content:flex-start;padding:6px 10px;
}
.canvas-wrap{
  width:100%;max-width:1200px;flex:1;display:flex;align-items:center;justify-content:center;
}
#game{
  width:100%;height:calc(100vh - 240px);max-width:1100px;max-height:760px;background:#000;border-radius:14px;border:8px solid rgba(7,16,36,0.9);
  box-shadow:0 12px 40px rgba(2,6,20,0.7);display:block;
}

.overlay-card{
  width:100%;max-width:1100px;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg, rgba(13,22,36,0.65), rgba(4,8,14,0.45));
  border:1px solid rgba(255,255,255,0.02);color:var(--muted);font-size:13px;
}

.stat-row{display:flex;align-items:center;gap:8px}

@media (max-width:900px){
  .container{grid-template-columns:1fr; padding:12px; gap:12px;}
  .sidebar{height:auto;position:relative;border-radius:12px;}
  #game{height:420px}
}
</style>
</head>
<body>

<div class="container">
  <aside class="sidebar" aria-label="Oldalsáv">
    <div class="stats" aria-hidden="false">
      <div class="stat-card">
        <small>Pont</small>
        <div class="val"><span id="score">0</span></div>
      </div>
      <div class="stat-card">
        <small>Életek</small>
        <div class="val"><span id="lives">3</span></div>
      </div>
      <div class="stat-card">
        <small>Pajzs</small>
        <div class="val"><span id="shield">0</span></div>
      </div>
      <div class="stat-card">
        <small>Pénz</small>
        <div class="val"><span id="money">0</span></div>
      </div>
    </div>

    <div class="controls" role="group" aria-label="Játék vezérlők">
      <div class="btn" id="persistWrap" title="Fejlesztések megőrzése">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="text-align:left">
            <div style="font-weight:700">Fejlesztések megmaradása</div>
            <small style="color:var(--muted)">Újrakezdés után</small>
          </div>
        </div>
        <button id="persistUpgrades" style="background:transparent;border:0;color:var(--gold)">KI</button>
      </div>

      <div class="btn" id="muteBtn" title="Hang ki/be">
        <div style="text-align:left">
          <div style="font-weight:700">Hang</div>
          <small style="color:var(--muted)">KI/BE</small>
        </div>
        <button id="toggleMute" style="background:transparent;border:0;color:var(--gold)">KI</button>
      </div>

      <div style="display:flex;align-items:center;gap:12px" id="ujra">
        <div class="btn secondary" style="flex-shrink:0">
          <div style="font-weight:700">Újrakezd</div>
        </div>
      
        <div class="btn" style="flex-shrink:0;display:flex;align-items:center;gap:6px;padding:6px 10px;font-size:12px;">
          <span>Homing:</span>
          <strong id="homingShotsLeft">15</strong> / 15
        </div>
      </div>
    </div>

    <div class="upgradePanel" id="upgradePanel">
      <h3 style="margin:0 0 6px 0;color:var(--accent)">Fejlesztések</h3>

      <div class="upgrade-list">
        <div class="upgrade-item">
          <div class="meta">
            <div style="font-weight:700">Lövés Sebesség</div>
            <small style="color:var(--muted)">+1 lövés/mp</small>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="min-width:48px;text-align:right;color:var(--muted)" id="priceRate">50</div>
            <button data-upg="rate">Vásárlás</button>
          </div>
        </div>

        <div class="upgrade-item">
          <div class="meta">
            <div style="font-weight:700">Sebesség</div>
            <small style="color:var(--muted)">+0.5 mozgás</small>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="min-width:48px;text-align:right;color:var(--muted)" id="priceSpeed">40</div>
            <button data-upg="speed">Vásárlás</button>
          </div>
        </div>

        <div class="upgrade-item">
          <div class="meta">
            <div style="font-weight:700">Lövedék sebzés</div>
            <small style="color:var(--muted)">+1 sebzés</small>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="min-width:48px;text-align:right;color:var(--muted)" id="priceDamage">60</div>
            <button data-upg="damage">Vásárlás</button>
          </div>
        </div>

        <div class="upgrade-item">
          <div class="meta">
            <div style="font-weight:700">Homing lövedék</div>
            <small style="color:var(--muted)">Célkövető lövedék</small>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <div style="min-width:48px;text-align:right;color:var(--muted)" id="priceHoming">500</div>
            <button data-upg="homing">Vásárlás</button>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;color:var(--muted);display:flex;justify-content:space-between;align-items:center">
        <div>Vásárlások száma: <strong id="upgradesCount">0</strong></div>
        <div>Homing szint: <strong id="homingLevel">0</strong></div>
      </div>
    </div>
  </aside>

  <main class="stage" role="main">
    <div class="canvas-wrap">
      <canvas id="game" width="900" height="600"></canvas>
    </div>
  </main>
</div>

<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const W=canvas.width,H=canvas.height;
let paused=false;

const scoreEl=document.getElementById('score');
const livesEl=document.getElementById('lives');
const shieldEl=document.getElementById('shield');
const moneyEl=document.getElementById('money');
const upgradePanel=document.getElementById('upgradePanel');
const restartBtn=document.getElementById('restart');
const upgradesCountEl=document.getElementById('upgradesCount');
const persisttext=document.getElementById('persistUpgrades');
const persistBtn=document.getElementById('persistWrap');
const sfxShoot = new Audio('shoot.wav');
const sfxExplosion = new Audio('explosion.wav');
const sfxPickup = new Audio('pickup.wav');
const sfxShield = new Audio('shield.flac');
const sfxBossWarning = new Audio('bossWarning.wav');
const sfxAll = [sfxShoot, sfxExplosion, sfxPickup, sfxShield, sfxBossWarning];
let muted = false;

let keys={}, score=0, money=5000, lives=3, shield=0, gameOver=false;
let persistUpgrades=false;
let shieldActive=false, shieldTime=0;
let bosses = [];
let bossCooldown = 60;
let bossTimer = 0;

persistBtn.addEventListener('click',()=>{
  persistUpgrades=!persistUpgrades;
  persisttext.textContent=`${persistUpgrades?'BE':'KI'}`;
});

const ship={x:W/2,y:H-80,w:40,h:40,speed:3.2,fireRate:3,damage:1,lastShot:0,upgrades:0};
let priceRate=50, priceSpeed=40, priceDamage=60;
let bullets=[], enemies=[], enemyBullets=[], pickups=[], particles=[], popups=[];
let lastTime=0;
ship.homingLevel=0;
let priceHoming=500;
const homingAccuracy=[0,0.1,0.2,0.3];
let homingShots=[];
const HOMING_LIMIT=15, HOMING_WINDOW=30000;

const rand=(a,b)=>Math.random()*(b-a)+a;
const stars=Array.from({length:100},()=>({x:rand(0,W),y:rand(0,H),size:rand(1,2),speed:rand(0.2,0.7)}));

window.addEventListener('keydown',e=>{keys[e.key.toLowerCase()]=true;});
window.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});
document.addEventListener('keydown',e=>{if(e.code==='Escape'){paused=!paused;if(!paused) lastTime=performance.now();}});

upgradePanel.addEventListener('click', e => {
  if(!e.target.dataset.upg) return;

  e.preventDefault(); 

  const t = e.target.dataset.upg;
  if(t==='rate' && money >= priceRate){ money-=priceRate; ship.fireRate+=1; ship.upgrades++; priceRate=Math.floor(priceRate*1.6); }
  if(t==='speed' && money >= priceSpeed){ money-=priceSpeed; ship.speed+=0.5; ship.upgrades++; priceSpeed=Math.floor(priceSpeed*1.5); }
  if(t==='damage' && money >= priceDamage){ money-=priceDamage; ship.damage+=1; ship.upgrades++; priceDamage=Math.floor(priceDamage*1.7); }
  if(t==='homing' && money >= priceHoming && ship.homingLevel<3){ money-=priceHoming; ship.homingLevel++; ship.upgrades++; priceHoming=Math.floor(priceHoming*1.8); }

  updateUI();
});

upgradePanel.querySelectorAll('button').forEach(btn => {
  btn.addEventListener('keydown', e => {
    if(e.code === 'Space' || e.code === 'Enter') e.preventDefault();
  });
});

function resetGame(){
  score=0; lives=3; shield=0;
  ship.x=W/2; ship.y=H-80;
  if(!persistUpgrades){ship.speed=3.2;ship.fireRate=3;ship.damage=1;ship.upgrades=0;priceRate=50;priceSpeed=40;priceDamage=60;priceHoming=500;ship.homingLevel=0;}
  bullets=[]; enemies=[]; enemyBullets=[]; pickups=[]; particles=[]; popups=[];
  gameOver=false;
  updateUI();
  requestAnimationFrame(loop);
}

function updateUI(){
  scoreEl.textContent=Math.floor(score);
  livesEl.textContent=lives;
  if(shieldEl) shieldEl.textContent=shield;
  moneyEl.textContent=money;
  upgradesCountEl.textContent=ship.upgrades;
  const pr=document.getElementById('priceRate'); if(pr) pr.textContent=priceRate;
  const ps=document.getElementById('priceSpeed'); if(ps) ps.textContent=priceSpeed;
  const pd=document.getElementById('priceDamage'); if(pd) pd.textContent=priceDamage;
  const ph=document.getElementById('priceHoming'); if(ph) ph.textContent=priceHoming;
  const hl=document.getElementById('homingLevel'); if(hl) hl.textContent=ship.homingLevel;
  const hs = document.getElementById('homingShotsLeft');
  if(hs){
    const remaining = HOMING_LIMIT - homingShots.length;
    hs.textContent = remaining >= 0 ? remaining : 0;
  }
}

function spawnEnemy(){
  const size = Math.floor(rand(18,36));
  const dirX = (Math.random()<0.5?-1:1) * rand(0.3,1);
  const baseHp = 20;
  const hp = baseHp + ship.upgrades * 4;
  enemies.push({x:rand(size,W-size),y:-size,w:size,h:size,spd:rand(0.5,1.2)+ship.upgrades*0.05,shotTimer:rand(1.2,3),dirX,h:size,hp});
}


function spawnPickup(x,y){
  const t=Math.random();
  pickups.push({x,y,type:t<0.5?'shield':'money',amt:t<0.5?0:10+Math.floor(Math.random()*30)});
}

function spawnParticles(x,y,color,count=10,size=2){
  for(let i=0;i<count;i++){particles.push({x,y,vx:rand(-3,3),vy:rand(-3,3),life:rand(0.5,1.2),color,size});}
}

function spawnPopup(x,y,text,color='#fff',life=0.8){popups.push({x,y,text,color,life});}
function rectColl(a,b){return a&&b&&a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

function spawnBoss() {
  try{
    sfxBossWarning.currentTime = 0;
    sfxBossWarning.play();
  }catch(e){}
  setTimeout(() => {
    const baseHp = 200;
    const bossHp = baseHp + ship.upgrades * 25;
    const boss = {
      x: W/2 - 60,
      y: -120,
      w: 120,
      h: 120,
      hp: bossHp,
      spd: 0.3,
      shotTimer: 1,
      type: 'boss'
    };
    bosses.push(boss);
  }, 5000);
}


function updateBosses(dt){
  bossTimer += dt;
  if(bossTimer > bossCooldown){
    spawnBoss();
    bossTimer = 0;
  }

  bosses.forEach((b,bi)=>{
    if(!b) return;
    b.y += b.spd*dt*60;

    b.shotTimer -= dt;
    if(b.shotTimer <= 0){
      enemyBullets.push({x:b.x+b.w/2-6, y:b.y+b.h, w:12, h:18, spd:5});
      b.shotTimer = 1 + Math.random()*1.5;
    }

    if(rectColl(b, ship)){
      if(shieldActive || shield > 0) {
          shieldActive = false;
          shieldTime = 0;
      } else {
          lives--;
          if(lives <= 0) gameOver = true;
      }

      bosses[bi]=null;
    }

    bullets.forEach((bu,bi2)=>{
      if(!bu) return;
      if(rectColl(bu,b)){
        b.hp -= bu.damage;
        bullets[bi2]=null;
        spawnParticles(b.x+b.w/2,b.y+b.h/2,'#f55',10);
        if(b.hp<=0){
          bosses[bi]=null;
          spawnParticles(b.x+b.w/2,b.y+b.h/2,'#ff0',30);
          score += 500;
          money += 200;
        }
      }
    });

    if(b.hp<=0){
        bosses[bi]=null;
        spawnParticles(b.x+b.w/2,b.y+b.h/2,'#ff0',30);
        score += 500; 
        money += 1000; 
        spawnPopup(b.x+b.w/2,b.y, '+1000$', 'yellow');
    }
  });

  bosses = bosses.filter(b=>b);
}

function update(dt){
  if(gameOver) return;
  if(Math.random()<dt*0.6) spawnEnemy();

  if((keys['arrowleft']||keys['a'])&&ship.x>10) ship.x-=ship.speed*dt*60;
  if((keys['arrowright']||keys['d'])&&ship.x<W-ship.w-10) ship.x+=ship.speed*dt*60;
  if((keys['arrowup']||keys['w'])&&ship.y>10) ship.y-=ship.speed*dt*60;
  if((keys['arrowdown']||keys['s'])&&ship.y<H-ship.h-10) ship.y+=ship.speed*dt*60;

  if(shieldActive){
      shieldTime -= dt;
      if(shieldTime <= 0){
          shieldActive = false;
          shieldTime = 0;
      }
  }
  
  if(!shieldActive && shield > 0){
      shield--;
      shieldActive = true;
      shieldTime = 15;
      spawnPopup(ship.x+ship.w/2, ship.y, '+1 Shield újraaktiválva', '#6fe');
  }

  if(keys[' ']&&(performance.now()-ship.lastShot)>1000/ship.fireRate){
      bullets.push({x:ship.x+ship.w/2-4,y:ship.y-8,w:8,h:14,spd:10,damage:ship.damage,created:performance.now(),angle:-Math.PI/2});
      ship.lastShot=performance.now();
      try{ sfxShoot.currentTime = 0; sfxShoot.play(); }catch(e){}
  }

  if(keys['h']&&ship.homingLevel>0){
    const now=performance.now();
    if(!ship.lastHomingShot||now-ship.lastHomingShot>1000/ship.fireRate){
      homingShots=homingShots.filter(t=>now-t<HOMING_WINDOW);
      if(homingShots.length<HOMING_LIMIT){
        bullets.push({x:ship.x+ship.w/2-6,y:ship.y-12,w:12,h:18,spd:10,damage:ship.damage,created:now,angle:-Math.PI/2,homing:true});
        homingShots.push(now);
        try{ sfxShoot.currentTime = 0; sfxShoot.play(); }catch(e){}
        ship.lastHomingShot=now;
      }
    }
  }

  bullets.forEach(b=>{
    if(!b) return;

    if(performance.now()-b.created>5000){
      spawnParticles(b.x+b.w/2,b.y+b.h/2,'#ff0',20);
      const radius=50;
      enemies.forEach((e,ei)=>{
        if(!e) return;
        const dx=(e.x+e.w/2)-(b.x+b.w/2);
        const dy=(e.y+e.h/2)-(b.y+b.h/2);
        if(Math.sqrt(dx*dx+dy*dy)<=radius){
          e.h-=b.damage*2;
          spawnParticles(e.x+e.w/2,e.y+e.h/2,'#f55',10);
          if(e.h<=10){
            if(Math.random()<0.35)spawnPickup(e.x+e.w/2,e.y+e.h/2);
            score+=10; money+=8; spawnPopup(e.x,e.y,'+8','yellow');
            enemies[ei]=null;
            spawnParticles(e.x+e.w/2,e.y+e.h/2,'#ff0',15);
            try{ sfxExplosion.currentTime=0; sfxExplosion.play(); }catch(e){}
          }
        }
      });
      bullets[bullets.indexOf(b)]=null;
      return;
    }

    if(b.homing&&ship.homingLevel>0){
      let closest=null,dist=Infinity;
      enemies.forEach(e=>{
        if(!e) return;
        const dx=(e.x+e.w/2)-(b.x+b.w/2);
        const dy=(e.y+e.h/2)-(b.y+b.h/2);
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d<dist){dist=d;closest=e;}
      });

      if(closest){
        const dx=(closest.x+closest.w/2)-(b.x+b.w/2);
        const dy=(closest.y+closest.h/2)-(b.y+b.h/2);
        const angle=Math.atan2(dy,dx);
        if(b.angle===undefined)b.angle=-Math.PI/2;
        const accuracy=homingAccuracy[ship.homingLevel];
        const turnSpeed=0.2*accuracy;
        let delta=angle-b.angle;
        delta=((delta+Math.PI)%(2*Math.PI))-Math.PI;
        b.angle+=delta*turnSpeed;
        b.x+=Math.cos(b.angle)*b.spd*dt*60;
        b.y+=Math.sin(b.angle)*b.spd*dt*60;
      }else{
        b.y-=b.spd*dt*60;
      }
    }else{
      b.y-=b.spd*dt*60;
    }

    if(!b.lastParticleY)b.lastParticleY=b.y;
    if(Math.abs(b.y-b.lastParticleY)>10){
      spawnParticles(b.x+b.w/2,b.y,'#ffb86b',1);
      b.lastParticleY=b.y;
    }
  });

  bullets=bullets.filter(b=>b);

  enemies.forEach(en=>{
    if(!en) return;
    en.y+=en.spd*dt*60;
    en.x+=en.dirX*en.spd*dt*60;
    if(en.x<0){en.x=0;en.dirX*=-1;}
    if(en.x+en.w>W){en.x=W-en.w;en.dirX*=-1;}
    en.shotTimer-=dt;
    if(en.shotTimer<=0){
      enemyBullets.push({x:en.x+en.w/2-3,y:en.y+en.h,w:6,h:10,spd:4+Math.random()*1.6});
      en.shotTimer=1+Math.random()*1.5;
    }
  });
  enemies=enemies.filter(e=>e&&e.y<H+100);

  enemyBullets.forEach(b=>{
    if(!b) return;
    b.y+=b.spd*dt*60;
    if(!b.lastParticleY)b.lastParticleY=b.y;
    if(Math.abs(b.y-b.lastParticleY)>10){
      spawnParticles(b.x+b.w/2,b.y,'#ffd1d1',1);
      b.lastParticleY=b.y;
    }
  });

  enemyBullets.forEach((eb,ebi)=>{
    bullets.forEach((pb,bpi)=>{
      if(rectColl(eb,pb)){
        enemyBullets[ebi] = null;
        bullets[bpi] = null;
        spawnParticles(pb.x+pb.w/2, pb.y+pb.h/2, '#ffb86b', 5);
        spawnParticles(eb.x+eb.w/2, eb.y+eb.h/2, '#ffd1d1', 5);
      }
    });
  });

  enemyBullets=enemyBullets.filter(b=>b&&b.y<H+50);

  enemyBullets.forEach((b,bi)=>{
    if(!b) return;
    if(rectColl(b,ship)){
      enemyBullets[bi]=null;
      if(shieldActive || shield > 0) {
          shieldActive = false;
          shieldTime = 0;
      } else {
          lives--;
          if(lives <= 0) gameOver = true;
      }
    }
  });

  enemies.forEach((e,ei)=>{
    if(!e) return;
    if(rectColl(e,ship)){
      if(shieldActive || shield > 0) {
          shieldActive = false;
          shieldTime = 0;
      } else {
          lives--;
          if(lives <= 0) gameOver = true;
      }
      enemies[ei]=null;
    }
  });

  bullets.forEach((b,bi)=>{
    if(!b) return;
    enemies.forEach((e,ei)=>{
      if(!e) return;
      if(rectColl(b,e)){
        bullets[bi]=null;
        e.h-=10;
        spawnParticles(e.x+e.w/2,e.y+e.h/2,'#f55',5);
        if(e.h<=10){
          if(Math.random()<0.35)spawnPickup(e.x+e.w/2,e.y+e.h/2);
          score+=10; money+=8; spawnPopup(e.x,e.y,'+8','yellow');
          enemies[ei]=null;
          spawnParticles(e.x+e.w/2,e.y+e.h/2,'#ff0',15);
        }
      }
    });
  });

  bullets=bullets.filter(b=>b);
  enemies=enemies.filter(e=>e);

  pickups.forEach((p,pi)=>{
    if(!p) return;
    const rect={x:p.x-10,y:p.y-10,w:20,h:20};
    if(rectColl(rect,ship)){
      if(p.type==='shield'){
        if(!shieldActive){
          shieldActive=true; shieldTime=15;
          spawnPopup(p.x,p.y,'+1 Shield','#6fe');
          try{ sfxShield.currentTime=0; sfxShield.play(); }catch(e){}
        }else {
          shield++;
          spawnPopup(p.x,p.y,'+1 Shield','#6fe');
          try{ sfxShield.currentTime=0; sfxShield.play(); }catch(e){}
        }
      }else if(p.type==='money'){
          money+=p.amt;
          spawnPopup(p.x,p.y,'+'+p.amt,'yellow');
          try{ sfxPickup.currentTime=0; sfxPickup.play(); }catch(e){}
      }
      pickups[pi]=null;
    }
  });
  pickups=pickups.filter(p=>p);

  particles.forEach(p=>{if(!p)return;p.x+=p.vx*dt*60;p.y+=p.vy*dt*60;p.life-=dt;});
  particles=particles.filter(p=>p&&p.life>0);
  popups.forEach(p=>{if(!p)return;p.y-=dt*30;p.life-=dt;});
  popups=popups.filter(p=>p&&p.life>0);
  score+=dt*1.3;
  updateBosses(dt);
  updateUI();
}

function draw() {
  ctx.fillStyle = '#00101a';
  ctx.fillRect(0, 0, W, H);
  stars.forEach(s => {
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    ctx.fillRect(s.x, s.y, s.size, s.size);
    s.y += s.speed;
    if(s.y > H) s.y = 0;
  });

  ctx.save();
  ctx.translate(ship.x, ship.y);

  ctx.fillStyle = '#88f';
  ctx.beginPath();
  ctx.moveTo(ship.w/2, 0);
  ctx.lineTo(ship.w, ship.h);
  ctx.lineTo(0, ship.h);
  ctx.closePath();
  ctx.fill();

  if(shieldActive){
    const alpha = Math.max(0.2, shieldTime / 15);
    ctx.strokeStyle = `rgba(0,200,255,${alpha})`;
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(ship.w/2, ship.h/2, ship.w * 1.3, 0, Math.PI*2);
    ctx.stroke();
  }

  ctx.restore();

  bullets.filter(b => b).forEach(b => {
    ctx.fillStyle = '#ffb86b';
    ctx.fillRect(b.x, b.y, b.w, b.h);
  });

  enemies.filter(e => e).forEach(e => {
    ctx.fillStyle = '#f55';
    ctx.fillRect(e.x, e.y, e.w, e.h);
    ctx.fillStyle = '#222';
    ctx.fillRect(e.x, e.y - 6, e.w, 4);
    ctx.fillStyle = '#7f7';
    ctx.fillRect(e.x, e.y - 6, Math.max(0, (e.h/36)*e.w), 4);
  });

  enemyBullets.filter(b => b).forEach(b => {
    ctx.fillStyle = '#ffd1d1';
    ctx.fillRect(b.x, b.y, 6, 10);
  });

  pickups.filter(p => p).forEach(p => {
    if(p.type === 'shield'){
      ctx.fillStyle = '#6fe';
      ctx.beginPath();
      ctx.arc(p.x, p.y, 10, 0, Math.PI*2);
      ctx.fill();
    } else if(p.type === 'money'){
      ctx.fillStyle = 'yellow';
      ctx.fillRect(p.x - 8, p.y - 8, 16, 16);
    }
  });

  particles.filter(p => p).forEach(p => {
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, 2, 2);
  });

  popups.filter(p => p).forEach(p => {
    ctx.fillStyle = p.color;
    ctx.font = '16px sans-serif';
    ctx.fillText(p.text, p.x, p.y);
  });

  if(shieldActive){
    ctx.font = '16px Arial';
    ctx.fillStyle = '#0ff';
    ctx.fillText(`Shield: ${shieldTime.toFixed(1)}s`, 10, 30);
  }

  if(gameOver){
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = '#fff';
    ctx.font = '36px sans-serif';
    ctx.fillText('Vesztettél!', W/2-90, H/2);
  }

  bosses.forEach(b=>{
    ctx.fillStyle='#f0f';
    ctx.fillRect(b.x,b.y,b.w,b.h);
    ctx.fillStyle='#222';
    ctx.fillRect(b.x, b.y-10, b.w, 8);
    ctx.fillStyle='#0f0';
    ctx.fillRect(b.x, b.y-10, b.w * Math.max(0, b.hp/300), 8);
  });
}

function loop(ts){
    if(paused){
        draw();
        ctx.fillStyle='rgba(0,0,0,0.5)';
        ctx.fillRect(0,0,W,H);
        ctx.fillStyle='#fff';
        ctx.font='bold 48px Arial';
        ctx.fillText('PAUSE', W/2-90, H/2);
        requestAnimationFrame(loop);
        return;
    }

    if(!lastTime) lastTime = ts;
    const dt = Math.min(0.05,(ts-lastTime)/1000);
    update(dt);
    draw();
    lastTime = ts;
    if(!gameOver) requestAnimationFrame(loop);
}

document.getElementById('muteBtn').addEventListener('click', () => {
    muted = !muted;
    sfxAll.forEach(sfx => sfx.muted = muted);
    document.getElementById('toggleMute').textContent = muted ? 'BE' : 'KI';
});

document.getElementById('ujra').addEventListener('click', () => {
    resetGame();
});

document.getElementById('persistWrap').addEventListener('click', () => {
    resetGame();
});

resetGame();
requestAnimationFrame(loop);
</script>

</body>
</html>


